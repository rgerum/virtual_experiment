<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Virtuelles Praktikum - Abbildung durch Linsen</title>

    <link rel="icon" href="favicon.ico" type="image/x-icon">

    <script src="https://d3js.org/d3.v5.min.js"></script>

    <script src="js/plot.js"></script>
    <script src="js/slider.js"></script>
    <script src="js/svg_load.js"></script>

    <link rel="stylesheet" href="css/style.css" />
    <link rel="stylesheet" href="css/slider.css" />

</head>
<body>

<header>
<h1>Virtuelles Praktikum</h1>
<h2>Abbildung durch Linsen</h2>
</header>

<div class="container">
    <img style="width:100%; height: auto" id="sketch" src="optical.svg" />
</div>
<div class="container">

    <div class="property">
        <label>Linse</label><br/>
        <select value="10" name="lense_chooser" id="lense_chooser" oninput="lense_changed();">
            <option value="L1">L1</option>
            <option value="L2">L2</option>
            <option value="L4">L4</option>
            <option value="L6">L6</option>
            <option value="L2L6">L2+L6</option>
        </select>
    </div>

    <div id="slider1" class="property">
        <label>Linse bei 0cm</label>
        <input type="range" min="0" max="120" value="50" class="slider">
    </div>
    <div id="slider2" class="property">
        <label>Schirm bei 0cm</label>
        <input type="range" min="0" max="120" value="100" class="slider">
    </div>

    <div id="lens_plot" style="display: inline-block"></div>
    <div style="width:255px; heigth: 255px; overflow: hidden; border: 2px solid black; display: inline-block">
        <img id="image0" style="width: 255px;" src="https://freshgoldsa.co.za/wp-content/uploads/2012/07/Appel.Foto_-300x300.jpg"/>
    </div>
    <div style="width:255px; heigth: 255px; overflow: hidden; border: 2px solid black; display: inline-block">
        <img id="image" style="width: 255px;" src="https://freshgoldsa.co.za/wp-content/uploads/2012/07/Appel.Foto_-300x300.jpg"/>
    </div>

</div>
<script>
    function clamp(num, min, max) {
        return num <= min ? min : num >= max ? max : num;
    }

    async function loadLSTMSvg() {
        // load the svg image and replace it as an inline svg (needed to be able to access its elements)
        let svg_lif = await replaceImgWithSvg("#sketch");

        // add ruler
        var u = d3.select("#floor").append("g").selectAll("line").data(d3.range(0, 125, 5));
        u.enter().append("line").merge(u).attr("x1", d=>(d+25)).attr("x2", d=>(d+25)).attr("y1", 0).attr("y2", 1.5).style("stroke-width", 0.4).attr("stroke", "black");
        u.exit().remove();
        u = d3.select("#floor").append("g").selectAll("line").data(d3.range(0, 125, 10));
        u.enter().append("line").merge(u).attr("x1", d=>(d+25)).attr("x2", d=>(d+25)).attr("y1", 0).attr("y2", 2).style("stroke-width", 0.5).attr("stroke", "black");
        u.exit().remove();

        lense_changed();
        updateSketch();
    }
    loadLSTMSvg();

    function addPlotForce() {
        let plot1 = new Plot(d3.select("#lens_plot").append("svg"), {
            xlabel: "x position (cm)",
            ylabel: "y position (cm)",
            left: 50,
            top: 15,
            bottom: 7,
            innerwidth: 200,
            width: 200 + 50 + 10,
            innerheight: 176,
            height: 176 + 15 + 60,
            colors: ["#fc5252", "#fc5252", "#fc5252", "#fc5252", "#fc5252", "#fc5252", "#fc5252", "#fc5252", "#fc5252","#fc5252", "#fc5252"]
        });
        plot1.setXlim(0, 50)
        plot1.setYlim(-2, 2)
        plot1.y_axis.ticks(3)
        plot1.y_axis_svg.call(plot1.y_axis)
        plot1.y_axis_svg.selectAll(".tick").selectAll("text").attr("x", -18);

        plot1.x_axis.ticks(5)
        plot1.x_axis_svg.call(plot1.x_axis)

        return plot1
    }

    function rays_to_dict(rays) {
        let result = [];
        for(let n = 0; n < rays[0].length; n+=1) {
            result.push({x: [], y: []})
        }
        for(let t = 0; t < rays.length; t+=1) {
            for(let n = 0; n < rays[0].length; n+=1) {
                result[n].x.push(rays[t][n][0]);
                result[n].y.push(rays[t][n][1]);
            }
        }
        return result;
    }
    var elements = [
        [11, 5],
        [100, 10],
    ]

    const lens_defs = {
        "L1": 9,
        "L2": -7.5,
        "L4": 14.5,
        "L6": 6,
        "L2L6": 1/(-1/7.5 + 1/6),
    }

    function lense_changed() {
        for(let lensname in lens_defs)
            d3.select("#"+lensname).style("visibility", "hidden");
        let name = document.getElementById("lense_chooser").value;
        d3.select("#"+name).style("visibility", "visible");
        elements[0][1] = parseFloat(lens_defs[name]);
        updateSketch();
    }

    function calculateRays() {
        // define the rays
        let rays = [[
            [0, 1, 0],
            [0, 1, Math.atan(1/elements[0][0])],
            [0, 1, Math.atan(1/(elements[0][0]-elements[0][1]))],
        ]];

        // iterate over all elements
        for(let element of elements) {
            // get position and focal length of the element
            let x2 = element[0];
            let f = element[1];
            // iterate over all rays
            let new_rays = [];
            for(let i = 0; i < rays[0].length; i += 1) {
                // get the properties of the rays
                let [x1, y1, a1] = rays[rays.length-1][i];
                // calculate the new y position at the location of the lens
                let y2 = y1 - (x2 - x1) * Math.tan(a1);
                // calculate the new angle
                let a2 = Math.atan(Math.tan(a1)+y2/f);
                // add the new position of the ray to the list
                new_rays.push([x2, y2, a2])
            }
            // add the new positions of all rays to the list over all times
            rays.push(new_rays);
        }
        return rays;
    }

    // define the plot
    var plot = addPlotForce();

    // slicer lens
    let slider1 = d3.select("#slider1 input").node();
    slider1.oninput = function() {
        elements[0][0] = clamp(parseFloat(this.value), 3, elements[1][0]-3);
        updateSketch();
    };
    slider1.value = elements[0][0];

    // slider screen
    let slider2 = d3.select("#slider2 input").node();
    slider2.oninput = function() {
        elements[1][0] = clamp(parseFloat(this.value), elements[0][0]+3, 120);
        updateSketch();
    };
    slider2.value = elements[1][0];

    function updateSketch() {
        // move the lens and the screen
        d3.select("#lens1").style("transform", `translate(${elements[0][0]}px)`);
        d3.select("#screen").style("transform", `translate(${elements[1][0]}px)`);
        // calculate the rays
        let rays = calculateRays()
        // plot the rays
        plot.setData(rays_to_dict(rays))
        // calculate the scale and blur
        var diff = rays[rays.length-1][0][1]-rays[rays.length-1][rays[0].length-1][1];
        var mean = (rays[rays.length-1][0][1]+rays[rays.length-1][rays[0].length-1][1])/2;
        // blur and scale the images
        document.getElementById("image").style.filter = "blur("+Math.abs(diff*10)+"px)"
        document.getElementById("image").style.transform = "scale("+mean+")"
        d3.select("#f1").select("feGaussianBlur").attr("stdDeviation", Math.abs(diff)/2);
        d3.select("#image_scaler").style("transform", `scale(${mean})`);
        // update the text of the element positions
        d3.select("#slider1 label").text(`Linse bei ${elements[0][0].toString().padStart(3, '\u2007')}cm`)
        d3.select("#slider2 label").text(`Schirm bei ${elements[1][0].toString().padStart(3, '\u2007')}cm`)
    }


</script>
</body>
</html>